name: Publish container image

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: caddy-cf-naive

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # for pushing to GHCR
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - uses: DeterminateSystems/determinate-nix-action@main

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build, load, and push
        env:
          OWNER: ${{ github.repository_owner }}
          REF_NAME: ${{ github.ref_name }}
          REF_TYPE: ${{ github.ref_type }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          # Build the image
          nix build -L .#default

          # Load image (handling potential gzip compression from Nix)
          if gzip -t result 2>/dev/null; then
            gunzip -c result | docker load
          else
            docker load < result
          fi

          # Calculate target image name for GHCR (must be lowercase)
          owner_lc="$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')"
          target_image="${REGISTRY}/${owner_lc}/${IMAGE_NAME}"

          # Tag the loaded image (local name) to the target registry name
          # NOTE: The first argument must match what 'docker load' produced.
          docker tag "${IMAGE_NAME}:latest" "${target_image}:latest"
          docker tag "${IMAGE_NAME}:latest" "${target_image}:${SHA}"

          # Push to GHCR
          docker push "${target_image}:latest"
          docker push "${target_image}:${SHA}"

          # If this is a tag push (e.g. v1.0.0), push that tag too
          if [ "${REF_TYPE}" = "tag" ]; then
            docker tag "${IMAGE_NAME}:latest" "${target_image}:${REF_NAME}"
            docker push "${target_image}:${REF_NAME}"
          fi
